# tdirectory-operator

This is a sample project of golang based kubernetes operator to deploy a golang based application that uses mongodb.



Directory Structure

root - tdirectory-operator ==> Kubernetes operator generated using operator-sdk
     
     ---- tdirectory     ==> Telephone directory app that can add/update/get/delete user, this app uses mongodb to store the respective users
           
         ---- common     ==> contains common objects and utilities
         ---- db         ==> database related operations
         ---- handler    ==> handler functions for rest api calls
         ---- main.go    ==> entrypoint
     
     ---- deploy         ==> Helm charts to deploy tdirectory-operator to kubernetes cluster
     ---- controllers    ==> Has controller code generated by operator-sdk then later updated to create/update deployment/service for telephone directory application and mongodb, this also has code to expand volume.
     ---- config/samples ==> custom resorce definition to add tdirectory application and mongo db

Application build/image

cd tdirectory; make clean; make (this is also part of root directory makefile)

sample run:

manoj@virtualbox tdirectory % make clean; make
go clean
rm -rf tdirectory
make -C docker clean
make: *** docker: No such file or directory.  Stop.
make: *** [clean] Error 2
GOOS=linux go build
docker build -t tdirectory:v1 .
[+] Building 2.8s (7/7) FINISHED                                                                                                                                                                                                         docker:desktop-linux
 => [internal] load build definition from Dockerfile                                                                                                                                                                                                     0.0s
 => => transferring dockerfile: 268B                                                                                                                                                                                                                     0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                                        0.0s
 => => transferring context: 2B                                                                                                                                                                                                                          0.0s
 => [internal] load metadata for docker.io/library/ubuntu:latest                                                                                                                                                                                         2.3s
 => [internal] load build context                                                                                                                                                                                                                        0.2s
 => => transferring context: 12.33MB                                                                                                                                                                                                                     0.2s
 => [1/2] FROM docker.io/library/ubuntu:latest@sha256:ec050c32e4a6085b423d36ecd025c0d3ff00c38ab93a3d71a460ff1c44fa6d77                                                                                                                                   0.0s
 => => resolve docker.io/library/ubuntu:latest@sha256:ec050c32e4a6085b423d36ecd025c0d3ff00c38ab93a3d71a460ff1c44fa6d77                                                                                                                                   0.0s
 => => sha256:ec050c32e4a6085b423d36ecd025c0d3ff00c38ab93a3d71a460ff1c44fa6d77 1.13kB / 1.13kB                                                                                                                                                           0.0s
 => => sha256:56887c5194fddd8db7e36ced1c16b3569d89f74c801dc8a5adbf48236fb34564 424B / 424B                                                                                                                                                               0.0s
 => => sha256:01f29b872827fa6f9aed0ea0b2ede53aea4ad9d66c7920e81a8db6d1fd9ab7f9 2.30kB / 2.30kB                                                                                                                                                           0.0s
 => [2/2] ADD tdirectory /tdirectory                                                                                                                                                                                                                     0.1s
 => exporting to image                                                                                                                                                                                                                                   0.1s
 => => exporting layers                                                                                                                                                                                                                                  0.1s
 => => writing image sha256:6470554f71c1aa7c02e117f7d9dc8764ad4af5a3c92da55de2298df735cce576                                                                                                                                                             0.0s
 => => naming to docker.io/library/tdirectory:v1                                                                                                                                                                                                         0.0s

What's Next?
  View summary of image vulnerabilities and recommendations → docker scout quickview
manoj@virtualbox tdirectory % docker images
REPOSITORY                                                                   TAG                                                                          IMAGE ID       CREATED         SIZE
tdirectory                                                                   v1                                                                           6470554f71c1   8 seconds ago   90.2MB


Running tdirectory-operator


manoj@virtualbox tdirectory-operator % make install run                                 
test -s /Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen && /Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen --version | grep -q v0.11.1 || \
	GOBIN=/Users/manoj/Workspace/src/tdirectory-operator1/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1
/Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases
test -s /Users/manoj/Workspace/src/tdirectory-operator1/bin/kustomize || { curl -Ss "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 3.8.7 /Users/manoj/Workspace/src/tdirectory-operator1/bin; }
make: *** [/Users/manoj/Workspace/src/tdirectory-operator1/bin/kustomize] Killed: 9
manoj@virtualbox tdirectory-operator % make run
test -s /Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen && /Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen --version | grep -q v0.11.1 || \
	GOBIN=/Users/manoj/Workspace/src/tdirectory-operator1/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1
/Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases
/Users/manoj/Workspace/src/tdirectory-operator1/bin/controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."
go fmt ./...
go vet ./...
go run ./main.go
2023-08-22T17:54:06+05:30	INFO	controller-runtime.metrics	Metrics server is starting to listen	{"addr": ":8080"}
2023-08-22T17:54:06+05:30	INFO	setup	starting manager
2023-08-22T17:54:06+05:30	INFO	Starting server	{"path": "/metrics", "kind": "metrics", "addr": "[::]:8080"}
2023-08-22T17:54:06+05:30	INFO	Starting server	{"kind": "health probe", "addr": "[::]:8081"}
2023-08-22T17:54:06+05:30	INFO	Starting EventSource	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "source": "kind source: *v1.Tdirectory"}
2023-08-22T17:54:06+05:30	INFO	Starting EventSource	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "source": "kind source: *v1.Service"}
2023-08-22T17:54:06+05:30	INFO	Starting Controller	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory"}
2023-08-22T17:54:06+05:30	INFO	Starting workers	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "worker count": 1}
2023-08-22T17:56:08+05:30	INFO	Event received	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "Tdirectory": {"name":"tdirectory-sample","namespace":"tdirectory-operator"}, "namespace": "tdirectory-operator", "name": "tdirectory-sample", "reconcileID": "7eb0bd08-122a-43dc-b54d-e0c1e3a4efd6"}
2023-08-22T17:56:08+05:30	INFO	Request: 	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "Tdirectory": {"name":"tdirectory-sample","namespace":"tdirectory-operator"}, "namespace": "tdirectory-operator", "name": "tdirectory-sample", "reconcileID": "7eb0bd08-122a-43dc-b54d-e0c1e3a4efd6", "req": "tdirectory-operator/tdirectory-sample"}
2023-08-22T17:56:08+05:30	INFO	mongodb statefulset not found, will be created	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "Tdirectory": {"name":"tdirectory-sample","namespace":"tdirectory-operator"}, "namespace": "tdirectory-operator", "name": "tdirectory-sample", "reconcileID": "7eb0bd08-122a-43dc-b54d-e0c1e3a4efd6"}
2023-08-22T17:56:08+05:30	INFO	Creating a new Deployment	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "Tdirectory": {"name":"tdirectory-sample","namespace":"tdirectory-operator"}, "namespace": "tdirectory-operator", "name": "tdirectory-sample", "reconcileID": "7eb0bd08-122a-43dc-b54d-e0c1e3a4efd6", "Deployment.Namespace": "tdirectory-operator", "Deployment.Name": "tdirectory-sample"}
2023-08-22T17:56:08+05:30	INFO	✨ Creating a new Service	{"controller": "tdirectory", "controllerGroup": "testoperators.tdirectory.com", "controllerKind": "Tdirectory", "Tdirectory": {"name":"tdirectory-sample","namespace":"tdirectory-operator"}, "namespace": "tdirectory-operator", "name": "tdirectory-sample", "reconcileID": "7eb0bd08-122a-43dc-b54d-e0c1e3a4efd6", "Service.Namespace": "tdirectory-operator", "Service.Name": "tdirectory-sample"}


applying crd

manoj@virtualbox tdirectory % export KUBECONFIG=/Users/manoj/.kube/config
manoj@virtualbox tdirectory % kubectl create ns tdirectory-operator
namespace/tdirectory-operator created
manoj@virtualbox tdirectory % cd ..                   
manoj@virtualbox tdirectory-operator % kubectl apply -f ./config/samples/testoperators_v1_tdirectory.yaml -n tdirectory-operator
tdirectory.testoperators.tdirectory.com/tdirectory-sample created
manoj@virtualbox tdirectory-operator % kubectl get ns                                                                           
NAME                  STATUS   AGE
default               Active   166m
kube-node-lease       Active   166m
kube-public           Active   166m
kube-system           Active   166m
tdirectory-operator   Active   72s
manoj@virtualbox tdirectory-operator % kubectl -n tdirectory-operator get pods
NAME                                READY   STATUS    RESTARTS   AGE
mongodb-0                           1/1     Running   0          20s
tdirectory-sample-88dc4ccc6-zhn6g   1/1     Running   0          20s
manoj@virtualbox tdirectory-operator % 

gmanojkumar@C2VZP1N3MD6N tdirectory-operator % 
